<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produits</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="accueil.css">
    <link rel="stylesheet" href="Produit.css">
    <script type="module" src="script.js" defer></script>
</head>
<style>

h3 {
    font-size: 1.75rem;
    font-weight: bold;
    text-align: center;
}
/* Sidebar styles */
#sidebar {
    height: 100%;
    width: 250px;
    position: fixed;
    top: 0;
    left: -250px; /* Initialement caché */
    background-color: rgb(255, 255, 255);
    overflow-x: hidden;
    transition: 0.3s;
    padding-top: 60px;
    z-index: 1000; /* Assure que le sidebar est au-dessus des autres éléments */
}

#sidebar.open-sidebar {
    left: 0;
}

#sidebar a {
    padding: 10px 15px;
    text-decoration: none;
    font-size: 18px;
    color: #3949AB;
    display: block;
    transition: 0.3s;
    font-weight: bolder;
}

#sidebar a:hover {
    color: #000000;
}

/* Additional styles for card */
.cartes-container {
    position: sticky;
    top: 0;
    z-index: 1000; /* Assure que les cartes sont au-dessus du contenu lors du défilement */
    background-color: #fff; /* Ajouter un fond blanc pour éviter les problèmes de visibilité */
    padding: 10px; /* Ajouter un peu de padding pour séparer les cartes du bord */
    margin-bottom: 20px;
    z-index: 1;
}

.carte {
    flex: 0 0 100%;
    display: none;
    text-align: center;
    padding: 20px;
    color: #fff;
    font-size: 1.2em;
    border-radius: 10px;
}

#carte-achetes {
    background-color: green;
}

#carte-non-achetes {
    background-color: rgb(0, 0, 0);
}

#carte-tous-produits {
    background-color: rgba(219, 219, 36, 0.74);
    color: #000;
}

.carte.show {
    display: block;
    animation: slide-in 1s forwards;
}

@keyframes slide-in {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(0);
    }
}

.btn-group .btn {
    margin: 0 50px;
}

.product-card.purchased {
    background-color: green;
    color: white;
}

</style>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <button class="navbar-toggler" type="button" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Accueil</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Historique</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/mesplanning.html">Mes Planning</a>
                </li>
            </ul>
        </div>
    </nav>

    <div id="sidebar">
        <a href="#">Accueil</a>
        <a href="#">Historique</a>
        <a href="/mesplanning.html">Mes Planning</a>
        <a href="javascript:void(0)" id="logout-link">Deconnexion</a>
    </div>

    <div class="cartes-container" id="cartes-container">
        <div class="carte" id="carte-achetes">
            <h4>Somme totale des produits achetés</h4>
            <p id="somme-achetes">0 FCFA</p>
        </div>
        <div class="carte" id="carte-non-achetes">
            <h4>Somme totale des produits non achetés</h4>
            <p id="somme-non-achetes">0 FCFA</p>
        </div>
        <div class="carte" id="carte-tous-produits">
            <h4>Somme totale de tous les produits</h4>
            <p id="somme-tous-produits">0 FCFA</p>
        </div>
    </div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h3 id="plannedDateTime">Courses du  </h3>
                <div class="d-flex flex-wrap justify-content-center" id="productCards"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getDatabase, ref, get, remove, set } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBHPaYRAkOE1VTo9hv3tkseUFnGfJkvtUo",
            authDomain: "gestionachats-1112.firebaseapp.com",
            projectId: "gestionachats-1112",
            storageBucket: "gestionachats-1112.appspot.com",
            messagingSenderId: "1014952416832",
            appId: "1:1014952416832:web:33fdda900d4ff03e9db1a5"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const productCards = document.getElementById('productCards');
        const plannedDate = localStorage.getItem('plannedDate');

        const renderProductCards = () => {
            const productsRef = ref(database, `products/${plannedDate}`);
            get(productsRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const products = snapshot.val();
                        productCards.innerHTML = '';
                        Object.keys(products).forEach(key => {
                            const product = products[key];
                            const productCard = document.createElement('div');
                            productCard.className = 'product-card card m-2';
                            productCard.dataset.key = key;
                            if (product.purchased) {
                                productCard.classList.add('purchased');
                            }
                            productCard.innerHTML = `
                                <div class="card-body">
                                    <p><strong>${product.name}</strong></p>
                                    <p>Prix Unitaire = ${product.unitPrice} FCFA</p>
                                    <p>Quantité = ${product.quantity}</p>
                                    <p>Total = ${product.total} FCFA</p>
                                    <p><input type="checkbox" class="purchase-checkbox" ${product.purchased ? 'checked' : ''}> Déjà acheté</p><br>
                                    <div class="btn-group">
                                        <button class="btn btn-warning btn-sm btn-edit"><i class="fas fa-edit"></i> </button>
                                        <button class="btn btn-danger btn-sm btn-delete"><i class="fas fa-trash"></i> </button>
                                     </div>
                                </div>
                            `;
                            productCard.querySelector('.purchase-checkbox').addEventListener('change', function () {
                                productCard.classList.toggle('purchased', this.checked);
                                updateProductPurchaseStatus(key, this.checked);
                            });
                            productCard.querySelector('.btn-edit').addEventListener('click', function () {
                                editProduct(key);
                            });
                            productCard.querySelector('.btn-delete').addEventListener('click', function () {
                                deleteProduct(key);
                            });
                            productCards.appendChild(productCard);
                        });
                        updateSommes(snapshot);
                    }
                });
        };

        const editProduct = (key) => {
            const productsRef = ref(database, `products/${plannedDate}/${key}`);
            get(productsRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const product = snapshot.val();
                        localStorage.setItem('productKey', key);
                        localStorage.setItem('productData', JSON.stringify(product));
                        window.location.href = 'ajout.html';
                    }
                });
        };

        const deleteProduct = (key) => {
            const productRef = ref(database, `products/${plannedDate}/${key}`);
            remove(productRef)
                .then(() => {
                    alert("Produit supprimé avec succès !");
                    renderProductCards();
                })
                .catch((error) => {
                    alert("Erreur lors de la suppression du produit : " + error.message);
                });
        };

        const updateProductPurchaseStatus = (key, purchased) => {
            const productRef = ref(database, `products/${plannedDate}/${key}`);
            get(productRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const product = snapshot.val();
                    product.purchased = purchased;
                    product.total = product.unitPrice * product.quantity;
                    set(productRef, product);
                }
            }).then(() => {
                const productsRef = ref(database, `products/${plannedDate}`);
                get(productsRef).then((snapshot) => {
                    updateSommes(snapshot);
                });
            });
        };

        const cartesContainer = document.getElementById('cartes-container');
        const carteAchetes = document.getElementById('carte-achetes');
        const carteNonAchetes = document.getElementById('carte-non-achetes');
        const carteTousProduits = document.getElementById('carte-tous-produits');

        let sommeAchetes = 0;
        let sommeNonAchetes = 0;
        let sommeTousProduits = 0;

        // Mettre à jour les sommes
        function updateSommes(snapshot) {
            sommeAchetes = 0;
            sommeNonAchetes = 0;
            sommeTousProduits = 0;

            // Calculer les sommes
            const products = snapshot.val();
            Object.keys(products).forEach(key => {
                const product = products[key];
                if (product.purchased) {
                    sommeAchetes += product.total;
                } else {
                    sommeNonAchetes += product.total;
                }
                sommeTousProduits += product.total;
            });

            // Mettre à jour les cartes
            carteAchetes.querySelector('p').textContent = `${sommeAchetes} FCFA`;
            carteNonAchetes.querySelector('p').textContent = `${sommeNonAchetes} FCFA`;
            carteTousProduits.querySelector('p').textContent = `${sommeTousProduits} FCFA`;
        }

        // Animer les cartes
        function animateCartes() {
            const cartes = cartesContainer.children;
            let currentCarte = 0;

            setInterval(() => {
                cartes[currentCarte].classList.remove('show');
                currentCarte = (currentCarte + 1) % cartes.length;
                cartes[currentCarte].classList.add('show');
            }, 2000);
        }

        animateCartes();

        document.getElementById('plannedDateTime').textContent = `Courses du ${plannedDate}`;

        renderProductCards();

        // Sidebar Toggle
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("open-sidebar");
        }

        document.querySelector('.navbar-toggler').addEventListener('click', function () {
            toggleSidebar();
        });

    </script>
</body>

</html>
